networks:
  {{ compose_project_name }}_network:
    driver: bridge
    ipam:
      config:
        - subnet: {{ network_subnet }}

{% if compose_volumes | length > 0 %}
volumes:
{% for volume in compose_volumes %}
  {{ volume.name }}:
    driver: {{ volume.driver | default('local') }}
{% if volume.driver_opts is defined %}
    driver_opts:
{% for key, value in volume.driver_opts.items() %}
      {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

{% if compose_secrets | length > 0 %}
secrets:
{% for secret in compose_secrets %}
  {{ secret.name }}:
    file: {{ secret.file }}
{% endfor %}
{% endif %}

services:
{% for service in compose_services %}
  {{ service.name }}:
    image: {{ service.image }}
{% if service.build is defined %}
    build:
      context: {{ service.build.context | default('.') }}
      dockerfile: {{ service.build.dockerfile | default('Dockerfile') }}
{% if service.build.args is defined %}
      args:
{% for key, value in service.build.args.items() %}
        {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% endif %}
    container_name: {{ service.container_name | default(compose_project_name + '_' + service.name) }}
    restart: {{ service.restart | default('unless-stopped') }}
{% if service.user is defined %}
    user: {{ service.user }}
{% endif %}
{% if service.environment is defined %}
    environment:
{% for key, value in service.environment.items() %}
      {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% if service.env_file is defined %}
    env_file:
{% for env_file in service.env_file %}
      - {{ env_file }}
{% endfor %}
{% endif %}
{% if service.ports is defined %}
    ports:
{% for port in service.ports %}
      - "{{ port }}"
{% endfor %}
{% endif %}
{% if service.volumes is defined %}
    volumes:
{% for volume in service.volumes %}
      - {{ volume }}
{% endfor %}
{% endif %}
{% if service.secrets is defined %}
    secrets:
{% for secret in service.secrets %}
      - {{ secret }}
{% endfor %}
{% endif %}
{% if service.depends_on is defined %}
    depends_on:
{% for dependency in service.depends_on %}
      - {{ dependency }}
{% endfor %}
{% endif %}
{% if service.healthcheck is defined %}
    healthcheck:
      test: {{ service.healthcheck.test }}
      interval: {{ service.healthcheck.interval | default('30s') }}
      timeout: {{ service.healthcheck.timeout | default('10s') }}
      retries: {{ service.healthcheck.retries | default(3) }}
      start_period: {{ service.healthcheck.start_period | default('60s') }}
{% endif %}
    networks:
      - {{ compose_project_name }}_network
{% if service.security_opt is defined %}
    security_opt:
{% for opt in service.security_opt %}
      - {{ opt }}
{% endfor %}
{% endif %}
{% if service.cap_drop is defined %}
    cap_drop:
{% for cap in service.cap_drop %}
      - {{ cap }}
{% endfor %}
{% endif %}
{% if service.cap_add is defined %}
    cap_add:
{% for cap in service.cap_add %}
      - {{ cap }}
{% endfor %}
{% endif %}
    read_only: {{ service.read_only | default(false) | lower }}
{% if service.tmpfs is defined %}
    tmpfs:
{% for mount in service.tmpfs %}
      - {{ mount }}
{% endfor %}
{% endif %}
{% if service.labels is defined %}
    labels:
{% for key, value in service.labels.items() %}
      {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

{% endfor %}