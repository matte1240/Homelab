# Configurazione dinamica per Traefik - Environment: {{ env_name | default('unknown') }}
http:
  # Global redirect to https
  routers:
{% if deploy_proxmox_routes | default(false) %}
    # Proxmox HTTPS Router (only in production)
    proxmox-https:
      rule: "Host(`pve.{{ domain_name }}`)"
      entryPoints:
        - https
      middlewares:
        - proxmox-headers
{% if security_headers_enabled | default(true) %}
        - security-headers
{% endif %}
      service: proxmox
{% if ssl_enabled | default(true) and lets_encrypt_enabled | default(true) %}
      tls:
        certResolver: letsencrypt
{% endif %}
    
    # Proxmox HTTP Router (redirect to HTTPS)
    proxmox-http:
      rule: "Host(`pve.{{ domain_name }}`)"
      entryPoints:
        - http
      middlewares:
        - redirect-to-https
      service: proxmox
{% endif %}
    
    # Global HTTP to HTTPS redirect
    http-catchall:
      rule: "hostregexp(`{host:.+}`)"
      entryPoints:
        - http
      middlewares:
        - redirect-to-https
      service: api@internal
  
  middlewares:
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

{% if deploy_proxmox_routes | default(false) %}    
    # Headers per Proxmox (only when Proxmox is deployed)
    proxmox-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Real-IP: "{{ ansible_default_ipv4.address }}"
          X-Forwarded-For: "{{ ansible_default_ipv4.address }}"
          X-Forwarded-Host: "pve.{{ domain_name }}"
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
{% endif %}

{% if security_headers_enabled | default(true) %}
    # Security headers for production environment
    security-headers:
      headers:
        customResponseHeaders:
          X-XSS-Protection: "1; mode=block"
          X-Frame-Options: "DENY"
          X-Content-Type-Options: "nosniff"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' wss:; font-src 'self'; object-src 'none'; media-src 'self'; frame-src 'self';"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains"
{% endif %}

{% if deploy_proxmox_routes | default(false) %}
  services:
    proxmox:
      loadBalancer:
        servers:
          - url: "https://{{ proxmox_host | default('192.168.178.70') }}:8006"
        serversTransport: insecure-transport

  serversTransports:
    insecure-transport:
      serverName: ""
      insecureSkipVerify: true
{% endif %}
